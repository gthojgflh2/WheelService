package com.example.bot;

import com.example.app.Env;
import com.example.db.UserDao;
import com.example.db.UserDao.WheelPrize;
import com.example.db.PromoDao;
import com.example.db.LotteryPrize;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.telegram.telegrambots.meta.api.methods.AnswerCallbackQuery;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.methods.updatingmessages.EditMessageText;
import org.telegram.telegrambots.meta.api.objects.CallbackQuery;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.InlineKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.InlineKeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;
import org.telegram.telegrambots.meta.api.objects.webapp.WebAppInfo;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class WheelService {
    private static final Logger log = LoggerFactory.getLogger(WheelService.class);
    private final SelfNotesBot bot;
    private static final String MINI_APP_URL = "https://wheelservice.onrender.com";

    // –í–µ—Å–∞ –¥–ª—è –ø—Ä–∏–∑–æ–≤ (—á–µ–º –±–æ–ª—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
    private static final Map<WheelPrize, Integer> PRIZE_WEIGHTS = new LinkedHashMap<>() {{
        put(WheelPrize.ACCESS_1H, 30);      // 30%
        put(WheelPrize.ACCESS_2H, 20);      // 20%
        put(WheelPrize.ACCESS_3H, 15);      // 15%
        put(WheelPrize.BALANCE_25, 12);      // 12%
        put(WheelPrize.EXTRA_SPIN, 8);       // 8%
        put(WheelPrize.ACCESS_6H, 5);        // 5%
        put(WheelPrize.LOTTERY_FREE, 4);     // 4%
        put(WheelPrize.BALANCE_50, 3);       // 3%
        put(WheelPrize.SLOTS_2_2W, 2);       // 2%
        put(WheelPrize.PROMOCODE, 1);        // 1%
    }};

    public WheelService(SelfNotesBot bot) {
        this.bot = bot;
    }

    public void sendWheelMenu(long chatId) {
        // –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–ª—É—á–∞–µ–º –°–í–ï–ñ–ò–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
        boolean canSpin = UserDao.canSpinWheel(chatId);
        int extraSpins = UserDao.getExtraSpins(chatId);
        String stats = UserDao.getWheelStats(chatId);

        // –î–æ–±–∞–≤–ª—è–µ–º timestamp –∏ random –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ URL
        long timestamp = System.currentTimeMillis();
        int random = new Random().nextInt(1000000);

        String text = String.format("""
üé° <b>–ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´</b>

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ –∫–æ–ª–µ—Å–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π!

<b>üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
%s

<b>‚ú® –î–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–æ–∫—Ä—É—Ç–æ–≤:</b>
‚Ä¢ üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é): %s
‚Ä¢ ‚≠ê –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ: <b>%d</b>

‚¨áÔ∏è <b>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∫—Ä—É—Ç–∏—Ç—å!</b>
""",
                stats,
                canSpin ? "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω" : "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω",
                extraSpins
        );

        // –î–æ–±–∞–≤–ª—è–µ–º timestamp –∏ random –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        String url = MINI_APP_URL + "?user=" + chatId +
                "&canSpin=" + canSpin +
                "&extraSpins=" + extraSpins +
                "&t=" + timestamp +
                "&r=" + random;

        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–æ–ª–µ—Å–∞
        KeyboardButton wheelButton = new KeyboardButton();
        wheelButton.setText("üé° –û–¢–ö–†–´–¢–¨ –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´");
        wheelButton.setWebApp(new WebAppInfo(url));

        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
        KeyboardButton cancelButton = new KeyboardButton();
        cancelButton.setText("‚ùå –û—Ç–º–µ–Ω–∞");

        // –ü–µ—Ä–≤—ã–π —Ä—è–¥ - —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ –∫–æ–ª–µ—Å–∞
        KeyboardRow row1 = new KeyboardRow();
        row1.add(wheelButton);

        // –í—Ç–æ—Ä–æ–π —Ä—è–¥ - –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
        KeyboardRow row2 = new KeyboardRow();
        row2.add(cancelButton);

        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–≤—É–º—è —Ä—è–¥–∞–º–∏
        List<KeyboardRow> keyboard = new ArrayList<>();
        keyboard.add(row1);
        keyboard.add(row2);

        ReplyKeyboardMarkup markup = new ReplyKeyboardMarkup();
        markup.setKeyboard(keyboard);
        markup.setResizeKeyboard(true);
        markup.setOneTimeKeyboard(false);

        try {
            bot.execute(SendMessage.builder()
                    .chatId(String.valueOf(chatId))
                    .text(text)
                    .parseMode("HTML")
                    .replyMarkup(markup)
                    .build());
        } catch (Exception e) {
            log.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é –∫–æ–ª–µ—Å–∞: {}", e.getMessage());
        }
    }

    public void handleWebAppData(long chatId, String data) {
        log.info("========== WHEEL WEBAPP DATA ==========");
        log.info("User ID: {}", chatId);
        log.info("Raw data: {}", data);

        try {
            // –ü–û–õ–£–ß–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ò–ó –ë–î
            boolean canSpinNow = UserDao.canSpinWheel(chatId);
            int extraSpinsNow = UserDao.getExtraSpins(chatId);

            log.info("üìä Current DB state - canSpin: {}, extraSpins: {}", canSpinNow, extraSpinsNow);

            com.google.gson.JsonObject json = com.google.gson.JsonParser.parseString(data).getAsJsonObject();

            if (!json.has("type") || !json.has("prize")) {
                log.error("‚ùå Missing required fields in JSON");
                bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
                return;
            }

            String spinType = json.get("type").getAsString();
            com.google.gson.JsonObject prizeObj = json.get("prize").getAsJsonObject();

            String prizeName = prizeObj.get("name").getAsString();
            int prizeValue = prizeObj.get("value").getAsInt();

            log.info("üéØ Spin type: {}, Prize: {} ({})", spinType, prizeName, prizeValue);
            
            // –õ–æ–≥–∏—Ä—É–µ–º ASCII –∫–æ–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            log.info("üîç Prize name char codes:");
            for (int i = 0; i < prizeName.length(); i++) {
                log.info("  char[{}]: '{}' = {}", i, prizeName.charAt(i), (int) prizeName.charAt(i));
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–æ–≤
            if ("free".equals(spinType)) {
                if (!canSpinNow) {
                    log.error("üö® FRAUD DETECTED: User {} tried to use free spin but has none in DB", chatId);
                    bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞: –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Ä—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!\n\n–ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–∫—Ä—É—Ç—ã –≤ –±–æ—Ç–µ.");

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –æ –ø–æ–ø—ã—Ç–∫–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
                    notifyAdminsAboutFraud(chatId, "FREE_SPIN_FRAUD");
                    return;
                }
            } else if ("extra".equals(spinType)) {
                if (extraSpinsNow <= 0) {
                    log.error("üö® FRAUD DETECTED: User {} tried to use extra spin but has none in DB", chatId);
                    bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–∫—Ä—É—Ç–æ–≤!\n\n–ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–∫—Ä—É—Ç—ã –≤ –±–æ—Ç–µ.");

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –æ –ø–æ–ø—ã—Ç–∫–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
                    notifyAdminsAboutFraud(chatId, "EXTRA_SPIN_FRAUD");
                    return;
                }
            } else {
                log.warn("Unknown spin type: {}", spinType);
                bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–æ–∫—Ä—É—Ç–∞");
                return;
            }

            // –ú–∞–ø–ø–∏–º –ø—Ä–∏–∑
            WheelPrize prize = mapPrize(prizeName, prizeValue);
            log.info("üéÅ Mapped prize: {}", prize != null ? prize.name() : "null");

            if (prize == null) {
                log.error("Failed to map prize: '{}' with value {}", prizeName, prizeValue);
                bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–∏–∑ '" + prizeName + "'");
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∞
            if ("free".equals(spinType)) {
                UserDao.saveWheelSpin(chatId, prize);
            } else {
                UserDao.useExtraSpin(chatId);
            }

            // –í—ã–¥–∞–µ–º –ø—Ä–∏–∑
            String prizeMessage = givePrize(chatId, prize);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            String resultText = String.format("""
üéâ <b>–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!</b>

üé° –ö–æ–ª–µ—Å–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å –Ω–∞...

<b>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</b>
<b>‚ïë   %s   ‚ïë</b>
<b>‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</b>

%s

‚ú® –ü—Ä–∏–∑ —É–∂–µ –≤–∞—à! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å —É–º–æ–º.
""", prize.description, prizeMessage);

            List<List<InlineKeyboardButton>> buttons = new ArrayList<>();
            buttons.add(List.of(
                    InlineKeyboardButton.builder()
                            .text("üé° –ö–†–£–¢–ò–¢–¨ –ï–©–Å")
                            .callbackData("WHEEL_MENU")
                            .build(),
                    InlineKeyboardButton.builder()
                            .text("‚óÄÔ∏è –í –ü–†–û–§–ò–õ–¨")
                            .callbackData("BACK_TO_PROFILE")
                            .build()
            ));

            InlineKeyboardMarkup keyboard = new InlineKeyboardMarkup();
            keyboard.setKeyboard(buttons);

            bot.sendHtml(chatId, resultText, keyboard);

            log.info("‚úÖ Successfully processed wheel spin for user {}. Prize: {}", chatId, prize.name());

        } catch (Exception e) {
            log.error("‚ùå CRITICAL ERROR handling web app data: {}", e.getMessage(), e);
            bot.sendHtml(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: " + e.getMessage());
        }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –æ –ø–æ–ø—ã—Ç–∫–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
    private void notifyAdminsAboutFraud(long chatId, String fraudType) {
        String message = String.format("""
üö® <b>–û–ë–ù–ê–†–£–ñ–ï–ù–ê –ü–û–ü–´–¢–ö–ê –ú–û–®–ï–ù–ù–ò–ß–ï–°–¢–í–ê!</b>

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>%d</code>
üîç –¢–∏–ø: <b>%s</b>
‚è∞ –í—Ä–µ–º—è: <b>%s</b>

‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è –∫—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–æ–≤!
""", chatId, fraudType, new Date().toString());

        for (Long adminId : Env.ADMIN_IDS) {
            bot.sendHtml(adminId, message);
        }
    }

    private WheelPrize mapPrize(String prizeName, int value) {
        log.info(">>> mapPrize ENTER: name='{}', value={}", prizeName, value);

        if (prizeName == null) {
            log.error(">>> mapPrize: prizeName is null");
            return null;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –¥–ª—è –ª–æ–≥–æ–≤
        String originalName = prizeName;

        // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        prizeName = prizeName.trim();
        log.info(">>> mapPrize trimmed: '{}'", prizeName);

        // –ü—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–∑ HTML
        switch (prizeName) {
            case "1 –ß–ê–°":
                log.info(">>> mapPrize matched: ACCESS_1H (direct match)");
                return WheelPrize.ACCESS_1H;
            case "2 –ß–ê–°–ê":
                log.info(">>> mapPrize matched: ACCESS_2H (direct match)");
                return WheelPrize.ACCESS_2H;
            case "3 –ß–ê–°–ê":
                log.info(">>> mapPrize matched: ACCESS_3H (direct match)");
                return WheelPrize.ACCESS_3H;
            case "6 –ß–ê–°–û–í":
                log.info(">>> mapPrize matched: ACCESS_6H (direct match)");
                return WheelPrize.ACCESS_6H;
            case "2 –°–õ–û–¢–ê":
                log.info(">>> mapPrize matched: SLOTS_2_2W (direct match)");
                return WheelPrize.SLOTS_2_2W;
            case "–õ–û–¢–ï–†–ï–Ø":
                log.info(">>> mapPrize matched: LOTTERY_FREE (direct match)");
                return WheelPrize.LOTTERY_FREE;
            case "+1":
                log.info(">>> mapPrize matched: EXTRA_SPIN (direct match)");
                return WheelPrize.EXTRA_SPIN;
            case "–ü–†–û–ú–û":
                log.info(">>> mapPrize matched: PROMOCODE (direct match)");
                return WheelPrize.PROMOCODE;
            case "25 –ì–†–ù":
                log.info(">>> mapPrize matched: BALANCE_25 (direct match)");
                return WheelPrize.BALANCE_25;
            case "50 –ì–†–ù":
                log.info(">>> mapPrize matched: BALANCE_50 (direct match)");
                return WheelPrize.BALANCE_50;
            default:
                log.warn(">>> mapPrize: NO DIRECT MATCH for '{}', trying by value={}", prizeName, value);
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –ø—Ä–æ–±—É–µ–º –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é
                switch (value) {
                    case 60:
                        log.info(">>> mapPrize: matched by value 60 -> ACCESS_1H");
                        return WheelPrize.ACCESS_1H;
                    case 120:
                        log.info(">>> mapPrize: matched by value 120 -> ACCESS_2H");
                        return WheelPrize.ACCESS_2H;
                    case 180:
                        log.info(">>> mapPrize: matched by value 180 -> ACCESS_3H");
                        return WheelPrize.ACCESS_3H;
                    case 360:
                        log.info(">>> mapPrize: matched by value 360 -> ACCESS_6H");
                        return WheelPrize.ACCESS_6H;
                    case 2:
                        log.info(">>> mapPrize: matched by value 2 -> SLOTS_2_2W");
                        return WheelPrize.SLOTS_2_2W;
                    case 1:
                        // –î–ª—è value=1 –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                        if (originalName.contains("–õ–û–¢–ï–†–ï–Ø") || originalName.contains("–ª–æ—Ç–µ—Ä–µ—è")) {
                            log.info(">>> mapPrize: value=1 and name contains lottery -> LOTTERY_FREE");
                            return WheelPrize.LOTTERY_FREE;
                        } else {
                            log.info(">>> mapPrize: value=1 and name not lottery -> EXTRA_SPIN");
                            return WheelPrize.EXTRA_SPIN;
                        }
                    case 25:
                        log.info(">>> mapPrize: matched by value 25 -> BALANCE_25");
                        return WheelPrize.BALANCE_25;
                    case 50:
                        log.info(">>> mapPrize: matched by value 50 -> BALANCE_50");
                        return WheelPrize.BALANCE_50;
                    default:
                        log.error(">>> mapPrize: NO MATCH for name='{}', value={}", prizeName, value);
                        return null;
                }
        }
    }

    private String givePrize(long chatId, WheelPrize prize) {
        log.info("Giving prize to user {}: {} ({})", chatId, prize.name(), prize.description);

        switch (prize.type) {
            case "ACCESS":
                UserDao.addAccessMillis(chatId, prize.value * 60_000L);
                log.info("Added {} minutes access to user {}", prize.value, chatId);
                return String.format("‚úÖ <b>+%d –º–∏–Ω—É—Ç –¥–æ—Å—Ç—É–ø–∞</b> –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É!", prize.value);

            case "SLOTS":
                UserDao.addSlots(chatId, prize.value, 14L * 24 * 60 * 60 * 1000);
                log.info("Added {} slots for 2 weeks to user {}", prize.value, chatId);
                return String.format("‚úÖ <b>+%d —Å–ª–æ—Ç–∞ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏</b> –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!", prize.value);

            case "LOTTERY":
                log.info("Gave lottery ticket to user {}", chatId);
                return "üé∞ <b>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ª–æ—Ç–µ—Ä–µ—è!</b>\n–ù–∞–∂–º–∏—Ç–µ ¬´üé∞ –õ–æ—Ç–µ—Ä–µ—è¬ª –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏ —Å—ã–≥—Ä–∞–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!";

            case "EXTRA_SPIN":
                UserDao.addExtraSpins(chatId, 1, "wheel", 0);
                log.info("Added 1 extra spin to user {}", chatId);
                return "‚ú® <b>+1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–∫—Ä—É—Ç!</b> –û–Ω —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–æ–ª–µ—Å–µ —Ñ–æ—Ä—Ç—É–Ω—ã!";

            case "PROMO":
                LotteryPrize lotteryPrize = PromoDao.rollLotteryPrize();
                String promo = PromoDao.createLotteryPromo(lotteryPrize);
                log.info("Created promo code for user {}: {}", chatId, promo);
                return String.format("üéü <b>–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ %d –≥—Ä–Ω!</b>\n\n<code>%s</code>\n\n–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´üéÅ –ü—Ä–æ–º–æ–∫–æ–¥¬ª",
                        lotteryPrize.hours, promo);

            case "BALANCE":
                UserDao.addBalance(chatId, prize.value);
                log.info("Added {} balance to user {}", prize.value, chatId);
                return String.format("üí∞ <b>+%d –≥—Ä–Ω</b> –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å!", prize.value);

            default:
                log.error("Unknown prize type: {} for user {}", prize.type, chatId);
                return "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–∏–∑. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.";
        }
    }

    public void sendHowToGetInfo(long chatId, CallbackQuery cb) {
        int extraSpins = UserDao.getExtraSpins(chatId);
        log.info("Sending how-to-get info to user {}, extra spins: {}", chatId, extraSpins);

        String text = String.format("""
‚ùì <b>–ö–ê–ö –ü–û–õ–£–ß–ò–¢–¨ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ö–†–£–¢–´</b>

<b>1. ü§ù –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</b>
‚Ä¢ 4 –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö ‚Üí <b>+1 –ø—Ä–æ–∫—Ä—É—Ç</b>
‚Ä¢ 10 –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö ‚Üí <b>+3 –ø—Ä–æ–∫—Ä—É—Ç–∞</b>
‚Ä¢ 20 –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö ‚Üí <b>+5 –ø—Ä–æ–∫—Ä—É—Ç–æ–≤</b>

<b>2. üì± –í—ã–ø–æ–ª–Ω—è–π –º–∏—Å—Å–∏–∏</b>
‚Ä¢ TikTok –º–∏—Å—Å–∏—è ‚Üí <b>+1 –ø—Ä–æ–∫—Ä—É—Ç</b>
‚Ä¢ –û—Ç–∑—ã–≤ –≤ –∫–∞–Ω–∞–ª–µ ‚Üí <b>+1 –ø—Ä–æ–∫—Ä—É—Ç</b>

<b>3. üí∞ –ü–æ–∫—É–ø–∞–π –ø–æ–¥–ø–∏—Å–∫—É</b>
‚Ä¢ –ö–∞–∂–¥–∞—è –ø–æ–∫—É–ø–∫–∞ –æ—Ç 150 –≥—Ä–Ω ‚Üí <b>+1 –ø—Ä–æ–∫—Ä—É—Ç</b>

<b>4. üé∞ –£—á–∞—Å—Ç–≤—É–π –≤ –∫–æ–Ω–∫—É—Ä—Å–∞—Ö</b>
‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏
‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–≤–µ–Ω—Ç—ã

<b>5. üéÅ –°–ª–µ–¥–∏ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏</b>
–í –∫–∞–Ω–∞–ª–µ @SpamlordyChannel1 —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –∞–∫—Ü–∏–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–∫—Ä—É—Ç–∞–º–∏!

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî• <b>–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å:</b> %d –¥–æ–ø. –ø—Ä–æ–∫—Ä—É—Ç–æ–≤
""", extraSpins);

        List<List<InlineKeyboardButton>> buttons = new ArrayList<>();
        buttons.add(List.of(
                InlineKeyboardButton.builder()
                        .text("üé° –ù–ê–ó–ê–î –ö –ö–û–õ–ï–°–£")
                        .callbackData("WHEEL_MENU")
                        .build()
        ));

        InlineKeyboardMarkup keyboard = new InlineKeyboardMarkup();
        keyboard.setKeyboard(buttons);

        if (cb != null) {
            try {
                EditMessageText editMsg = EditMessageText.builder()
                        .chatId(String.valueOf(chatId))
                        .messageId(cb.getMessage().getMessageId())
                        .text(text)
                        .parseMode("HTML")
                        .replyMarkup(keyboard)
                        .build();
                bot.execute(editMsg);
                log.info("How-to-get info edited for user {}", chatId);
            } catch (Exception e) {
                log.error("Error editing message for user {}: {}", chatId, e.getMessage());
                bot.sendHtml(chatId, text, keyboard);
            }
        } else {
            bot.sendHtml(chatId, text, keyboard);
        }
    }
}
