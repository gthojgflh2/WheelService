package com.example.bot;

import com.example.db.UserDao;
import com.google.gson.Gson;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

public class WheelApiHandler {
    private static final Logger log = LoggerFactory.getLogger(WheelApiHandler.class);
    private static final Gson gson = new Gson();
    private static SelfNotesBot bot;

    public static void init(SelfNotesBot botInstance) {
        bot = botInstance;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
        Spark.options("/api/*", (request, response) -> {
            response.header("Access-Control-Allow-Origin", "*");
            response.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
            response.header("Access-Control-Allow-Headers", "Content-Type");
            return "OK";
        });

        Spark.before((request, response) -> {
            response.header("Access-Control-Allow-Origin", "*");
            response.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
            response.header("Access-Control-Allow-Headers", "Content-Type");
            response.type("application/json");
        });

        // –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–æ–ª–µ—Å–∞
        Spark.post("/api/wheel", (request, response) -> {
            try {
                String body = request.body();
                log.info("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: {}", body);
                
                JsonObject json = JsonParser.parseString(body).getAsJsonObject();
                long userId = json.get("userId").getAsLong();
                JsonObject data = json.get("data").getAsJsonObject();
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                bot.getWheelService().handleWebAppData(userId, data.toString());
                
                JsonObject result = new JsonObject();
                result.addProperty("success", true);
                result.addProperty("message", "‚úÖ –ü—Ä–∏–∑ –ø–æ–ª—É—á–µ–Ω");
                
                return gson.toJson(result);
                
            } catch (Exception e) {
                log.error("‚ùå –û—à–∏–±–∫–∞: {}", e.getMessage(), e);
                
                JsonObject error = new JsonObject();
                error.addProperty("success", false);
                error.addProperty("error", e.getMessage());
                
                response.status(500);
                return gson.toJson(error);
            }
        });
        
        log.info("‚úÖ API –≥–æ—Ç–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8080");
    }
}
